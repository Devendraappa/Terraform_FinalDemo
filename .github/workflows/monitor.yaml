name: Monitor GitHub-Runner Workflow

on:
  workflow_run:
    workflows:
      - Terraform Workflow with OIDC, SNS Notification, and Logs Upload to s3
    types:
      - completed

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Capture Start Time
      - name: Capture Start Time
        id: start_time
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      # Step 3: Simulate Workload
      - name: Simulate Workload
        run: |
          echo "Running workload..."
          sleep 10

      # Step 4: Capture End Time
      - name: Capture End Time
        id: end_time
        run: echo "END_TIME=$(date +%s)" >> $GITHUB_ENV

      # Step 5: Calculate Metrics and Push to Prometheus
      - name: Push Metrics to Prometheus
        env:
          START_TIME: ${{ env.START_TIME }}
          END_TIME: ${{ env.END_TIME }}
          RUN_DURATION: $((END_TIME - START_TIME)) # Calculate duration in seconds
        run: |
          echo "RUN_DURATION=${RUN_DURATION}" # Debugging output
          curl -X POST --data "github_runner_duration_seconds{job=\"github_runner\", status=\"${{ job.status }}\"} ${RUN_DURATION}" https://c5f4-49-43-241-70.ngrok-free.app/metrics
